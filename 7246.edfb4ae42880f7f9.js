"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7246],{7246:(U,L,w)=>{w.r(L),w.d(L,{SocialLoginWeb:()=>R});var i=w(467),O=w(5083);let p=(()=>{class u extends O.E_{constructor(){super()}parseJwt(e){const n=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(n).split("").map(s=>"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}loadScript(e){return(0,i.A)(function*(){return new Promise((o,n)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>{o()},r.onerror=n,document.body.appendChild(r)})})()}}return u.OAUTH_STATE_KEY="social_login_oauth_pending",u})();class b extends p{constructor(){super(...arguments),this.clientId=null,this.redirectUrl=null,this.scriptLoaded=!1,this.scriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"}initialize(t,e){var o=this;return(0,i.A)(function*(){o.clientId=t,o.redirectUrl=e||null,t&&(yield o.loadAppleScript())})()}login(t){var e=this;return(0,i.A)(function*(){if(!e.clientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!e.scriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise((o,n)=>{var r;AppleID.auth.init({clientId:e.clientId,scope:(null===(r=t.scopes)||void 0===r?void 0:r.join(" "))||"name email",redirectURI:e.redirectUrl||window.location.href,state:t.state,nonce:t.nonce,usePopup:!0}),AppleID.auth.signIn().then(s=>{var l,a,c,g,h;const m={profile:{user:s.user||"",email:(null===(l=s.user)||void 0===l?void 0:l.email)||null,givenName:(null===(c=null===(a=s.user)||void 0===a?void 0:a.name)||void 0===c?void 0:c.firstName)||null,familyName:(null===(h=null===(g=s.user)||void 0===g?void 0:g.name)||void 0===h?void 0:h.lastName)||null},accessToken:{token:s.authorization.id_token||""},idToken:s.authorization.code||null};o({provider:"apple",result:m})}).catch(s=>{n(s)})})})()}logout(){return(0,i.A)(function*(){console.log("Apple logout: Session should be managed on the client side")})()}isLoggedIn(){return(0,i.A)(function*(){return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1}})()}getAuthorizationCode(){return(0,i.A)(function*(){throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available")})()}refresh(){return(0,i.A)(function*(){console.log("Apple refresh not available on web")})()}loadAppleScript(){var t=this;return(0,i.A)(function*(){if(!t.scriptLoaded)return t.loadScript(t.scriptUrl).then(()=>{t.scriptLoaded=!0})})()}}class y extends p{constructor(){super(...arguments),this.appId=null,this.scriptLoaded=!1}initialize(t){var e=this;return(0,i.A)(function*(){e.appId=t,t&&(yield e.loadFacebookScript(),FB.init({appId:e.appId,version:"v17.0",xfbml:!0,cookie:!0}))})()}login(t){var e=this;return(0,i.A)(function*(){if(!e.appId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise((o,n)=>{FB.login(r=>{"connected"===r.status?FB.api("/me",{fields:"id,name,email,picture"},s=>{var l,a;const c={accessToken:{token:r.authResponse.accessToken,userId:r.authResponse.userID},profile:{userID:s.id,name:s.name,email:s.email||null,imageURL:(null===(a=null===(l=s.picture)||void 0===l?void 0:l.data)||void 0===a?void 0:a.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};o({provider:"facebook",result:c})}):n(new Error("Facebook login failed"))},{scope:t.permissions.join(",")})})})()}logout(){return(0,i.A)(function*(){return new Promise(t=>{FB.logout(()=>t())})})()}isLoggedIn(){return(0,i.A)(function*(){return new Promise(t=>{FB.getLoginStatus(e=>{t({isLoggedIn:"connected"===e.status})})})})()}getAuthorizationCode(){return(0,i.A)(function*(){return new Promise((t,e)=>{FB.getLoginStatus(o=>{var n;"connected"===o.status?t({jwt:(null===(n=o.authResponse)||void 0===n?void 0:n.accessToken)||""}):e(new Error("No Facebook authorization code available"))})})})()}refresh(t){var e=this;return(0,i.A)(function*(){yield e.login(t)})()}loadFacebookScript(){var t=this;return(0,i.A)(function*(){if(!t.scriptLoaded)return t.loadScript("https://connect.facebook.net/en_US/sdk.js").then(()=>{t.scriptLoaded=!0})})()}}class G extends p{constructor(){super(...arguments),this.clientId=null,this.loginType="online",this.GOOGLE_TOKEN_REQUEST_URL="https://www.googleapis.com/oauth2/v3/tokeninfo",this.GOOGLE_STATE_KEY="capgo_social_login_google_state"}initialize(t,e,o){var n=this;return(0,i.A)(function*(){n.clientId=t,e&&(n.loginType=e),n.hostedDomain=o})()}login(t){var e=this;return(0,i.A)(function*(){if(!e.clientId)throw new Error("Google Client ID not set. Call initialize() first.");let o=t.scopes||[];o.length>0?(o.includes("https://www.googleapis.com/auth/userinfo.email")||o.push("https://www.googleapis.com/auth/userinfo.email"),o.includes("https://www.googleapis.com/auth/userinfo.profile")||o.push("https://www.googleapis.com/auth/userinfo.profile"),o.includes("openid")||o.push("openid")):o=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","openid"];const n=t.nonce||Math.random().toString(36).substring(2);return e.traditionalOAuth({scopes:o,nonce:n,hostedDomain:e.hostedDomain})})()}logout(){var t=this;return(0,i.A)(function*(){if("offline"===t.loginType)return Promise.reject("Offline login doesn't store tokens. logout is not available");const e=t.getGoogleState();e&&(yield t.rawLogoutGoogle(e.accessToken))})()}isLoggedIn(){var t=this;return(0,i.A)(function*(){if("offline"===t.loginType)return Promise.reject("Offline login doesn't store tokens. isLoggedIn is not available");const e=t.getGoogleState();if(!e)return{isLoggedIn:!1};try{const o=yield t.accessTokenIsValid(e.accessToken),n=t.idTokenValid(e.idToken);if(o&&n)return{isLoggedIn:!0};try{yield t.rawLogoutGoogle(e.accessToken,!1)}catch(r){console.error("Access token is not valid, but cannot logout",r)}return{isLoggedIn:!1}}catch(o){return Promise.reject(o)}})()}getAuthorizationCode(){var t=this;return(0,i.A)(function*(){if("offline"===t.loginType)return Promise.reject("Offline login doesn't store tokens. getAuthorizationCode is not available");const e=t.getGoogleState();if(!e)throw new Error("No Google authorization code available");try{const o=yield t.accessTokenIsValid(e.accessToken),n=t.idTokenValid(e.idToken);if(o&&n)return{accessToken:e.accessToken,jwt:e.idToken};try{yield t.rawLogoutGoogle(e.accessToken,!1)}catch(r){console.error("Access token is not valid, but cannot logout",r)}throw new Error("No Google authorization code available")}catch(o){return Promise.reject(o)}})()}refresh(){return(0,i.A)(function*(){return Promise.reject("Not implemented")})()}handleOAuthRedirect(t){const e=t.searchParams,o=e.get("code");if(o&&e.has("scope"))return{provider:"google",result:{serverAuthCode:o,responseType:"offline"}};const n=t.hash.substring(1);if(console.log("handleOAuthRedirect",t.hash),!n)return null;console.log("handleOAuthRedirect ok");const r=new URLSearchParams(n),s=r.get("access_token"),l=r.get("id_token");if(s&&l){localStorage.removeItem(p.OAUTH_STATE_KEY);const a=this.parseJwt(l);return{provider:"google",result:{accessToken:{token:s},idToken:l,profile:{email:a.email||null,familyName:a.family_name||null,givenName:a.given_name||null,id:a.sub||null,name:a.name||null,imageUrl:a.picture||null},responseType:"online"}}}return null}accessTokenIsValid(t){var e=this;return(0,i.A)(function*(){const o=`${e.GOOGLE_TOKEN_REQUEST_URL}?access_token=${encodeURIComponent(t)}`;try{const n=yield fetch(o);if(!n.ok)return console.log(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response not successful. Status code: ${n.status}. Assuming that the token is not valid`),!1;const r=yield n.text();if(!r)throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`);let s;try{s=JSON.parse(r)}catch(c){throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${c}`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${c}`)}const l=s.expires_in;if(null==l)throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`);let a;try{if(a=parseInt(l,10),isNaN(a))throw new Error("'expires_in' is not a valid integer")}catch(c){throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${l} is not a valid integer. Error: ${c}`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${l} is not a valid integer. Error: ${c}`)}return a>5}catch(n){throw console.error(n),n}})()}idTokenValid(t){try{const e=this.parseJwt(t),o=Math.ceil(Date.now()/1e3)+5;return e.exp&&o<e.exp}catch{return!1}}rawLogoutGoogle(t,e=null){var o=this;return(0,i.A)(function*(){if(null===e&&(e=yield o.accessTokenIsValid(t)),!0===e)return new Promise((n,r)=>{try{google.accounts.oauth2.revoke(t,(0,i.A)(function*(){o.clearStateGoogle(),n()}))}catch(s){r(s)}});o.clearStateGoogle()})()}persistStateGoogle(t,e){try{window.localStorage.setItem(this.GOOGLE_STATE_KEY,JSON.stringify({accessToken:t,idToken:e}))}catch(o){console.error("Cannot persist state google",o)}}clearStateGoogle(){try{window.localStorage.removeItem(this.GOOGLE_STATE_KEY)}catch(t){console.error("Cannot clear state google",t)}}getGoogleState(){try{const t=window.localStorage.getItem(this.GOOGLE_STATE_KEY);if(!t)return null;const{accessToken:e,idToken:o}=JSON.parse(t);return{accessToken:e,idToken:o}}catch(t){return console.error("Cannot get state google",t),null}}traditionalOAuth({scopes:t,hostedDomain:e,nonce:o}){var n=this;return(0,i.A)(function*(){const r=[...new Set([...t||[],"openid"])],s=new URLSearchParams(Object.assign(Object.assign({client_id:n.clientId,redirect_uri:window.location.href,response_type:"offline"===n.loginType?"code":"token id_token",scope:r.join(" ")},o&&{nonce:o}),{include_granted_scopes:"true",state:"popup"}));void 0!==e&&s.append("hd",e);const l=`https://accounts.google.com/o/oauth2/v2/auth?${s.toString()}`,g=window.screenX+(window.outerWidth-500)/2,h=window.screenY+(window.outerHeight-600)/2;localStorage.setItem(p.OAUTH_STATE_KEY,"true");const m=window.open(l,"Google Sign In",`width=500,height=600,left=${g},top=${h},popup=1`);return new Promise((I,E)=>{if(!m)return void E(new Error("Failed to open popup"));const T=f=>{var A,k,S;if(!(f.origin!==window.location.origin||null!==(k=null===(A=f.data)||void 0===A?void 0:A.source)&&void 0!==k&&k.startsWith("angular")))if("oauth-response"===(null===(S=f.data)||void 0===S?void 0:S.type))if(window.removeEventListener("message",T),"online"===n.loginType){const{accessToken:v,idToken:_}=f.data;if(v&&_){const d=n.parseJwt(_);n.persistStateGoogle(v.token,_),I({provider:"google",result:{accessToken:{token:v.token},idToken:_,profile:{email:d.email||null,familyName:d.family_name||null,givenName:d.given_name||null,id:d.sub||null,name:d.name||null,imageUrl:d.picture||null},responseType:"online"}})}}else{const{serverAuthCode:v}=f.data.result;I({provider:"google",result:{responseType:"offline",serverAuthCode:v}})}else E(new Error("Login failed"))};window.addEventListener("message",T),setTimeout(()=>{window.removeEventListener("message",T),m.close(),E(new Error("OAuth timeout"))},3e5)})})()}}let R=(()=>{class u extends O.E_{constructor(){var e;if(super(),this.googleProvider=new G,this.appleProvider=new b,this.facebookProvider=new y,localStorage.getItem(u.OAUTH_STATE_KEY)){console.log("OAUTH_STATE_KEY found");const o=this.handleOAuthRedirect();o&&(null===(e=window.opener)||void 0===e||e.postMessage(Object.assign({type:"oauth-response"},o.result),window.location.origin),window.close())}}handleOAuthRedirect(){const e=new URL(window.location.href);return this.googleProvider.handleOAuthRedirect(e)}initialize(e){var o=this;return(0,i.A)(function*(){var n,r,s;const l=[];!(null===(n=e.google)||void 0===n)&&n.webClientId&&l.push(o.googleProvider.initialize(e.google.webClientId,e.google.mode,e.google.hostedDomain)),!(null===(r=e.apple)||void 0===r)&&r.clientId&&l.push(o.appleProvider.initialize(e.apple.clientId,e.apple.redirectUrl)),!(null===(s=e.facebook)||void 0===s)&&s.appId&&l.push(o.facebookProvider.initialize(e.facebook.appId)),yield Promise.all(l)})()}login(e){var o=this;return(0,i.A)(function*(){switch(e.provider){case"google":return o.googleProvider.login(e.options);case"apple":return o.appleProvider.login(e.options);case"facebook":return o.facebookProvider.login(e.options);default:throw new Error(`Login for ${e.provider} is not implemented on web`)}})()}logout(e){var o=this;return(0,i.A)(function*(){switch(e.provider){case"google":return o.googleProvider.logout();case"apple":return o.appleProvider.logout();case"facebook":return o.facebookProvider.logout();default:throw new Error(`Logout for ${e.provider} is not implemented`)}})()}isLoggedIn(e){var o=this;return(0,i.A)(function*(){switch(e.provider){case"google":return o.googleProvider.isLoggedIn();case"apple":return o.appleProvider.isLoggedIn();case"facebook":return o.facebookProvider.isLoggedIn();default:throw new Error(`isLoggedIn for ${e.provider} is not implemented`)}})()}getAuthorizationCode(e){var o=this;return(0,i.A)(function*(){switch(e.provider){case"google":return o.googleProvider.getAuthorizationCode();case"apple":return o.appleProvider.getAuthorizationCode();case"facebook":return o.facebookProvider.getAuthorizationCode();default:throw new Error(`getAuthorizationCode for ${e.provider} is not implemented`)}})()}refresh(e){var o=this;return(0,i.A)(function*(){switch(e.provider){case"google":return o.googleProvider.refresh();case"apple":return o.appleProvider.refresh();case"facebook":return o.facebookProvider.refresh(e.options);default:throw new Error(`Refresh for ${e.provider} is not implemented`)}})()}}return u.OAUTH_STATE_KEY="social_login_oauth_pending",u})()}}]);